name: Build Lepmon SD Card Image

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to create/use (e.g. v1.2.3). If empty, an auto tag is generated."
        required: false
      prerelease:
        description: "Mark release as prerelease"
        required: false
        type: boolean
        default: false

jobs:
  build-sd-image:
    runs-on: ubuntu-latest
    env:
      IMAGE_NAME_BASE: lepmon-sdcard

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Free disk
      run: |
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
        sudo docker image prune --all --force
        df -h

    - name: Deps
      run: |
        sudo apt-get update
        sudo apt-get install -y qemu-user-static binfmt-support parted kpartx zip wget curl xz-utils

    - name: Download RPi OS Lite 64 (Bookworm)
      run: |
        wget -O rpi-os-lite.img.xz https://downloads.raspberrypi.org/raspios_lite_arm64/images/raspios_lite_arm64-2024-03-15/2024-03-15-raspios-bookworm-arm64-lite.img.xz
        xz -d rpi-os-lite.img.xz

    - name: Expand image
      run: |
        dd if=/dev/zero bs=1M count=2048 >> rpi-os-lite.img
        sudo losetup -P /dev/loop0 rpi-os-lite.img
        sudo parted /dev/loop0 resizepart 2 100%
        sudo e2fsck -f -y -v /dev/loop0p2 || echo "e2fsck warnings ignored"
        sudo resize2fs /dev/loop0p2

    - name: Mount / chroot
      run: |
        mkdir -p /tmp/rpi-root
        sudo mount /dev/loop0p2 /tmp/rpi-root
        sudo mkdir -p /tmp/rpi-root/boot/firmware
        sudo mount /dev/loop0p1 /tmp/rpi-root/boot/firmware
        sudo cp /usr/bin/qemu-aarch64-static /tmp/rpi-root/usr/bin/
        sudo mount -t proc proc /tmp/rpi-root/proc
        sudo mount -t sysfs sysfs /tmp/rpi-root/sys
        sudo mount --bind /dev /tmp/rpi-root/dev
        sudo mount --bind /dev/pts /tmp/rpi-root/dev/pts
        sudo mkdir -p /tmp/rpi-root/home/Ento/LepmonOS
        sudo cp -r ./* /tmp/rpi-root/home/Ento/LepmonOS/ || true

    - name: Install in chroot
      run: |
        # Copy install script from repo instead of using heredoc
        sudo cp install_lepmon.sh /tmp/rpi-root/install_lepmon.sh
        sudo chmod +x /tmp/rpi-root/install_lepmon.sh
        sudo chroot /tmp/rpi-root /install_lepmon.sh

    - name: Unmount
      run: |
        sudo sync
        sudo umount /tmp/rpi-root/dev/pts || true
        sudo umount /tmp/rpi-root/dev || true
        sudo umount /tmp/rpi-root/sys || true
        sudo umount /tmp/rpi-root/proc || true
        sudo umount /tmp/rpi-root/boot/firmware || true
        sudo umount /tmp/rpi-root || true
        sudo losetup -d /dev/loop0

    - name: Compress
      run: |
        DATE=$(date +%Y%m%d)
        zip -9 lepmon-sdcard-${DATE}.img.zip rpi-os-lite.img
        ls -lh lepmon-sdcard-${DATE}.img.zip

    - name: Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: lepmon-sdcard-*.img.zip
        body: Lepmon SD Card Image - Insect Timelapse Monitoring System
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Artifact
      uses: actions/upload-artifact@v4
      with:
        name: lepmon-sdcard-image
        path: lepmon-sdcard-*.img.zip
        retention-days: 30

    # Compute the release tag for both tag-push and workflow_dispatch
    - name: Compute tag
      id: tag
      shell: bash
      run: |
        if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
          TAG="${GITHUB_REF#refs/tags/}"
        elif [[ -n "${{ github.event.inputs.tag }}" ]]; then
          TAG="${{ github.event.inputs.tag }}"
        else
          TAG="v$(date +%Y%m%d)-${GITHUB_RUN_NUMBER}"
        fi
        echo "tag=$TAG" >> "$GITHUB_OUTPUT"
        echo "TAG=$TAG" >> "$GITHUB_ENV"

    # Create or update the GitHub Release and upload asset
    - name: Release (create/update and upload asset)
      uses: ncipollo/release-action@v1
      with:
        tag: ${{ steps.tag.outputs.tag }}
        name: Lepmon ${{ steps.tag.outputs.tag }}
        body: |
          ## Lepmon SD Card Image
          
          Insect Timelapse Monitoring System for Raspberry Pi.
          
          ### Features
          - Allied Vision camera support with MJPEG streaming
          - WiFi Access Point for direct connection
          - Web UI for focus assistance and live preview
          - Automatic timelapse capture with exposure optimization
          - OLED display support
          - LoRa communication
          - Hardware PWM for LED control
          - I2C/SPI sensor support
          
          ### Default Credentials
          - User: Ento
          - Password: lepmon
          - WiFi AP SSID: Lepmon-XXXX-XXXX (unique per device)
          - WiFi AP Password: lepmon
          
          ### Quick Start
          1. Flash this image to an SD card (8GB+ recommended)
          2. Boot the Raspberry Pi
          3. Connect to WiFi AP "Lepmon-XXXX-XXXX" (password: lepmon)
          4. Access the web interface at http://192.168.4.1:8080/
          5. Or via Ethernet at http://<eth0-ip>:8080/
        prerelease: ${{ github.event.inputs.prerelease || false }}
        allowUpdates: true
        replacesArtifacts: false
        artifacts: "lepmon-sdcard-*.img.zip"
        artifactContentType: application/zip
        token: ${{ secrets.GITHUB_TOKEN }}
